# Replace 'yourdomain.com' with your actual domain
ragadmin.adilitech.com {
    # Enable automatic HTTPS with Let's Encrypt
    # Caddy will automatically obtain and renew SSL certificates

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"

        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"

        # Enable XSS protection
        X-XSS-Protection "1; mode=block"

        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Permissions policy
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        # Remove server header
        -Server
    }

    # Enable compression
    encode gzip zstd

    # API routes - proxy to backend
    handle /api/* {
        reverse_proxy backend:8000 {
            # Health check
            health_uri /health
            health_interval 30s
            health_timeout 5s

            # Connection settings
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            # ─────────────────────────────────────────────────────────────
            # Trace Context Propagation (W3C standard)
            # ─────────────────────────────────────────────────────────────
            # These headers enable distributed tracing across services.
            # When present in the incoming request, they're forwarded to
            # the backend so all services share the same trace context.
            #
            # traceparent: Contains trace_id + span_id + flags
            #   Format: 00-{trace_id}-{span_id}-{flags}
            #   Example: 00-abc123...-def456...-01
            #
            # tracestate: Vendor-specific trace data (optional)
            #   Format: vendor1=value1,vendor2=value2
            #
            # This enables end-to-end tracing: Browser → Caddy → Backend
            # All spans will share the same trace_id in SigNoz.
            # ─────────────────────────────────────────────────────────────
            header_up traceparent {header.traceparent}
            header_up tracestate {header.tracestate}
        }
    }

    # Frontend - serve React SPA static files
    handle /* {
        root * /srv

        # Try to serve the requested file, fallback to index.html for SPA routing
        try_files {path} /index.html

        # Serve files
        file_server

        # Cache static assets (js, css, images, fonts)
        @static {
            path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
        }
        header @static Cache-Control "public, max-age=31536000, immutable"

        # Don't cache index.html
        @html {
            path *.html
        }
        header @html Cache-Control "no-cache, no-store, must-revalidate"
    }

    # Access logs
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }

    # Error logs
    log {
        level ERROR
        output file /var/log/caddy/error.log {
            roll_size 10mb
            roll_keep 3
        }
    }
}

# Redirect www to non-www (optional - uncomment if needed)
# www.yourdomain.com {
#     redir https://yourdomain.com{uri} permanent
# }
